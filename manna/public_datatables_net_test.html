
<!DOCTYPE html>
<html lang="en">
	<head>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css"/>
 
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
		
	</head>
	<body>
		<div class="row mt-5">
			<div class="col-lg-2">
			</div>
			<div class="col-lg-8">
				<div class="card">
				  <div class="card-header">
				    <div class="d-flex justify-content-between">
				<h4>Kaikki varaukset</h4>
    
					<button 
					id="new_record_button"
        			style="color:#000066;"
					class="btn btn-primary"
					>					
						<span data-feather="plus"></span>
					</button>
  </div>
				  </div>
				  <div class="card-body">
					<div class="form-group">
<table id="example" class="display" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th>Nimi</th>
                <th>Aloitus</th>
                <th>Lopetus</th>
                <th></th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th></th>
                <th>Nimi</th>
                <th>Aloitus</th>
                <th>Lopetus</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
	</div>
	</div>
	</div>
	</div>
	</div>
	
	<script>
	
	function add_zero_if_needed(number) {
		if(number < 10){
			return number;
		}
		return number;
	};
	
	function convertToEuroDateAndTime(date) {
		
		return add_zero_if_needed(date.getDate())+"."
		+add_zero_if_needed((date.getMonth() + 1))+"."
		+date.getFullYear() + " " 
		+add_zero_if_needed(date.getHours()) + ":"
		+add_zero_if_needed(date.getMinutes());
	};
	async function get() {
		let url = 'http://localhost:8080/data/manna/all_hour_cards';
		let obj = await (await fetch(url)).json();
		
		return obj;
	}
	var custom_view;
	(async () => {
	  custom_view = await get();
	console.log(custom_view);
			var language = {
			"decimal":        "",
			"emptyTable":     "Ei dataa",
			"info":           "Hakutulokset _START_ - _END_ kaikista hakutuloksista (_TOTAL_)",
			"infoEmpty":      "Showing 0 to 0 of 0 entries",
			"infoFiltered":   "(Hakutuloksia _MAX_ kpl)",
			"infoPostFix":    "",
			"thousands":      ",",
			"lengthMenu":     "Hakutuloksia sivulla: _MENU_",
			"loadingRecords": "Ladataan...",
			"processing":     "Prosessoidaan...",
			"search":         "Haku:",
			"zeroRecords":    "Ei hakutuloksia",
			"paginate": {
				"first":      "<<",
				"last":       ">>",
				"next":       ">",
				"previous":   "<"
			},
			"aria": {
				"sortAscending":  ": Nouseva",
				"sortDescending": ": Laskeva"
			}
		};
		
	var tabledata = [
	];
	
	$.each(custom_view.records, function(index, record) {
		var login_date_EURO_FORMAT = "";
		if(record.columns.login_time.dateValue != undefined){
			var login_year = record.columns.login_time.dateValue.year;
			var login_month = record.columns.login_time.dateValue.month - 1;
			var login_day = record.columns.login_time.dateValue.day;
			var login_hour = record.columns.login_time.timeValue.hour;
			var login_minute = record.columns.login_time.timeValue.minute;
			var login_second = record.columns.login_time.timeValue.second;
			var login_date = new Date(login_year, login_month, login_day, login_hour, login_minute, 0, 0);
			login_date_EURO_FORMAT = convertToEuroDateAndTime(login_date);
		}
		var logout_date_EURO_FORMAT = "";
		if(record.columns.logout_time.dateValue != undefined){
			var logout_year = record.columns.logout_time.dateValue.year;
			var logout_month = record.columns.logout_time.dateValue.month - 1;
			var logout_day = record.columns.logout_time.dateValue.day;
			var logout_hour = record.columns.logout_time.timeValue.hour;
			var logout_minute = record.columns.logout_time.timeValue.minute;
			var logout_second = record.columns.logout_time.timeValue.second;
			var logout_date = new Date(logout_year, logout_month, logout_day, logout_hour, logout_minute, 0, 0);
			logout_date_EURO_FORMAT = convertToEuroDateAndTime(logout_date);
		}
		var edit_href = href="/public/views/" + custom_view.database_name + "/edit_via_rest?edit_view=" + custom_view.edit_view_name + "&record_id=" + record.id;
		tabledata.push([
			edit_href,
			record.columns.employee_name.stringValue,
			login_date_EURO_FORMAT,
			logout_date_EURO_FORMAT,
			record.id
		]);
	});
	
function delete_record(record_id_to_delete){

	var delete_url = '/CRUD_REST/' + custom_view.database_name + '/' + custom_view.view_name + '/' + record_id_to_delete + '/delete_record_REST';
	$.ajax({
	  type: "POST",
	  url: delete_url,
	  data: "{}",
	  dataType: "json",
	  contentType: "application/json; charset=utf-8",
           success: function (msg) {
				window.location.href = window.location.href;
           },
           error: function (error_msg) {
	     console.log("error!");
	     console.log(error_msg);
		   }
	});
}
 
$(document).ready(function() {
    var table = $('#example').DataTable( {
		language: language,
        data: tabledata,
        columns: [
            { title: "" },
            { title: "Nimi" },
            { title: "Aloitus" },
            { title: "Lopetus" },
            { title: "" }
        ],
		"columnDefs": [ 
			{
            "targets": -1,
            "data": null,
            "defaultContent": "<button class=\"deletebutton btn btn-danger\"><span data-feather=\"trash-2\"></span></button>"
			},
			{
            "targets": -5,
            "data": null,
            "defaultContent": "<button class=\"editlink btn btn-link\"><span data-feather=\"edit-2\"></span></button>"
			}
		]
    } );
	
	$('#example tbody').on( 'click', '.editlink', function () {
        var data = table.row( $(this).parents('tr') ).data();
		window.location.href = data[0];
    } );
	$('#example tbody').on( 'click', '.deletebutton', function () {
        var data = table.row( $(this).parents('tr') ).data();
		delete_record(data[4]);
    } );
	
  feather.replace()
} );
	})();
	</script>
	
	<script>

        $("#new_record_button").click( function()
           {
             window.location.href = 'http://localhost:8080/public/views/manna/edit_via_rest';
           }
        );
    </script>
	</body>
</html>