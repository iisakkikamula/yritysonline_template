<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <link href='https://unpkg.com/fullcalendar@5.3.0/main.css' rel='stylesheet' />
	
    <script src='https://unpkg.com/fullcalendar@5.3.0/main.min.js'></script>
			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>	

<script>
	async function get() {
    let url = 'http://localhost:8080/data/manna/all_hour_cards';
    let obj = await (await fetch(url)).json();
    
    return obj;
}
var custom_view;
(async () => {
  custom_view = await get();
  
  var all_times = [];
	$.each(custom_view.records, function(index, record) {
		var login_year = record.columns.login_time.dateValue.year;
		var login_month = record.columns.login_time.dateValue.month - 1;
		var login_day = record.columns.login_time.dateValue.day;
		var login_hour = record.columns.login_time.timeValue.hour;
		var login_minute = record.columns.login_time.timeValue.minute;
		var login_second = record.columns.login_time.timeValue.second;
		var login_date = new Date(login_year, login_month, login_day, login_hour, login_minute, 0, 0);
		var login_date_ISO_FORMAT = login_date.toISOString().substring(0,login_date.toISOString().length - 5);
		var logout_year = record.columns.logout_time.dateValue.year;
		var logout_month = record.columns.logout_time.dateValue.month - 1;
		var logout_day = record.columns.logout_time.dateValue.day;
		var logout_hour = record.columns.logout_time.timeValue.hour;
		var logout_minute = record.columns.logout_time.timeValue.minute;
		var logout_second = record.columns.logout_time.timeValue.second;
		var logout_date = new Date(logout_year, logout_month, logout_day, logout_hour, logout_minute, 0, 0);
		var logout_date_ISO_FORMAT = logout_date.toISOString().substring(0,logout_date.toISOString().length - 5);
		
		if("free" == record.columns.state.stringValue){
			all_times.push({
				title: "Vapaa",
				start: login_date_ISO_FORMAT,
				end: logout_date_ISO_FORMAT,
				url: "http://localhost:8080/public/manna/varaa_aika?record_id=" + record.id,
				color: "green"
			});
		}
		else{
			all_times.push({
				title: "Varattu",
				start: login_date_ISO_FORMAT,
				end: logout_date_ISO_FORMAT,
				color: "grey"
			});
		}
	});
	
  fill_calendar(all_times);
})()
</script>
    <script>

      function fill_calendar(all_times) {
        var calendarEl = document.getElementById('calendar');
		
        var calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'timeGridWeek',
			allDaySlot: false,
			stickyHeaderDates: true,
			slotMinTime: '08:00:00',
			slotMaxTime: '20:00:00',
			locale: 'fi',
			firstDay: 1,
			buttonText:{
			  today:    'Tanaan',
			  month:    'Kuukausi',
			  week:     'Viikko',
			  day:      'Paiva',
			  list:     'Lista'
			},
			nowIndicator: true,
			events: all_times,
			eventColor: '#378006',
			eventClick: function( info ) {
				info.jsEvent.preventDefault();
				if('reserved' == info.event.title){
				}
				else{
					location.href = info.event.url;	
				}
			}
			
		});
		
        calendar.render();
      };

    </script>
  </head>
  <body>
    <div id='calendar'></div>
  </body>
</html>